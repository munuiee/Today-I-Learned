# Concurrency
한번에 여러 작업을 동시에 수행하는 것을 목표로 하는 프로그래밍 방식

<br>

- 하나의 프로세스에는 여러 개의 스레드가 존재하며, 각 스레드에서 병렬 작업을 수행할 수 있다.
- 별도로 지정하지 않으면 메인 스레드에서 작업이 진행된다.

<br>

## 메인스레드
- **UI 작업을 할 수 있는 유일한 스레드**
- 별도로 스레드로 분리하지 않는다면, 모든 작업은 기본적으로 Main Thread에서 실행된다.
- 메인 스레드에서 모든 작업을 처리할 경우, 속도 지연 및 성능 저하 문제가 발생할 수 있다.

<br>

### GCD, Grand Central Dispatch
- iOS에서 제공하는 동시성 프로그래밍을 쉽게 처리하기 위한 도구
- 작업을 Queue에 추가하면 OS가 적절한 Thread에게 일을 할당하여 처리
- `DisptachQueue`를 사용하여 여러 개의 스레드에 업무를 분담 시킬 수 있다.
- `DispatchQueue`는 주로 2가지 큐를 제공
  - `Main Queue`
  - `Global Queue`
- Queue를 사용하기 때문에 먼저 들어온 업무를 먼저 Thread에 전달함
- Queue = FIFO 자료구조

<br>


## Main Queue
- Main Thread로 작업을 전달
- 들어온 일을 하나씩 처리한다고 하여 Serial Queue(직렬큐)라고 불린다.
<br>

```swift
DispatchQueue.main.async {
  // 작업
}
```

<br>

## Global Queue
들어온 여러가지의 작업을 동시에 처리할 수 있어서 Concurrent Queue(병렬큐)라고 부른다.
- Global Queue에 할 일을 추가하면 OS는 여러 개의 스레드에 작업을 나누어 처리
- 작업의 우선순위를 지정하는 Quality of Service(QoS)를 설정할 수 있다.
  - 우선순위를 통해 지원분배 효율적
  - `.userInteractive`
    - 가장 높은 우선순위, 사용자에게 즉각적인 반응을 줘야할 때 사용
    - 애니메이션, 터치 이벤트 등
  - `.userInitiated`
    - 문서열기, 이미지 로드 등
  - `.default`
  - `.utility`
    - 긴 시간이 걸릴 수 있는 작업
    - 백그라운드에서 데이터 동기화, 파일 다운로드 등
  - `.background`
    - 사용자에게 보이지 않거나 중요하지 않은 작업
    - 데이터 백업, 데이터 정리 등등
  - `.unspecified`
    - Qos가 지정되지 않은 상태로, 시스템이 우선순위를 정하게 함
    - 사용되지 않음

```swift
DispatchQueue.global(qos: .background).async {
  // 사용자에게 보이지 않거나 중요하지 않은 작업
}
```

<br>

## `async` vs `sync`
각각의 큐에는 **동기적**으로 작업을 하거나 **비동기적**으로 작업을 할당할 수 있다. 

### `sync` (동기)
- 작업이 순차적으로 실행
- 현재 작업이 끝날 때까지 다음 작업이 시작되지 않음
- 작업이 끝날 때까지 대기하기 때문에 대기시간 발생 가능
- 작업이 순서대로 실행되므로 코드의 흐름을 이해하기 편하고 디버깅이 간편, 그러나 성능 저하 발생 가능성

```swift
import UIKit

DispatchQueue.main.sync {
  print("Hello")
}

print("world")

// sync의 작업이 끝나기 전에 print("world")가 호출되지 않음
// Hello Wolrd 출력
```

<br>

### `async`
- 작업을 시작한 후 작업이 완료될 때까지 기다리지 않고 다음 코드를 바로 실행
- 여러 작업이 병행되어 빠른 처리가 가능하지만, 결과를 기다리는 구조로 인해 코드가 복잡해질 수 있음

```swift
import UIKit

DispatchQueue.global().async {
  Thread.sleep(forTimeInterval: 1)
  print("Hello")
}

print("Wolrd")

// async이기 때문에 바로 Wolrd가 호출된 후 1 뒤에 Hello가 호출됨

```
